<!DOCTYPE html>

<html lang="en">
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <meta charset="utf-8" />

    <title>News suggestion</title>
    <meta name="description" content="News suggestion" />

    <style>
      .hitbox {
        border-style: solid;
      }
    </style>
  </head>

  <body>
    Search for news<br />
    <input type="text" name="news_search_bar" id="search_input" />
    <br />
    <br />
    <input type="button" value="Search" onclick="search()" id="search_button" />
    <br />
    <br />
    <input type="button" value="Suggest news" onclick="suggest_news()" />

    <div id="results"></div>

    <script>
      // Called when the user clicks on a doc.
      function register_click() {
        // TODO:
        show_doc();
        update_clicks_for_document();
        update_topic_preferences();
      }

      function show_doc() {
        // TODO
      }

      function update_clicks_for_document() {
        // TODO
        // Update the counter.
      }

      function update_topic_preferences(document_topic_distribution) {

        // TODO
        // Probably incomplete and incorrect.
        var usr_topic_pref = get_usr_topic_pref();

        const alpha = 0.9;
        for (let i = 0; i < usr_topic_pref.length; i++) {
          usr_topic_pref[i] =
            usr_topic_pref[i] * alpha +
            document_topic_distribution[i] * (1 - alpha);
        }

        window.localStorage.setItem(
          "topic_preferences",
          JSON.stringify(my_item)
        );
      }

      function suggest_news() {
        // -----------------------------------
        // TODO: Remove
        // Just show something for now.
        var text = "";
        for (let i = 0; i < 4; i++) {
          text += "Suggested news piece " + i + "<br>";
        }
        document.getElementById("results").innerHTML = text;
        // ------------------------------------

        var usr_topic_pref = get_usr_topic_pref();

        // Sorting function
        let query = {};
        query["query"] = {};
        query["query"]["function_score"] = {};
        query["query"]["function_score"] = {
          script_score: {
            script: {
              lang: "painless",
              params: { usr_topic_pref },
              source:
                "double topic_dist = 0; \
                 for (int i = 0; i < params.usr_topic_pref.length && i < doc['points'].length; i++) { \
                   topic_dist += 1.0 / (1.0 + Math.abs(params.usr_topic_pref[i] - doc['points'][i])); \
                 } \
                 return topic_dist;"
            }
          }
        };

        $.ajax({
          method: "POST",
          dataType: "json",
          contentType: "application/json",
          url:
            "https://cors-anywhere.herokuapp.com/http://35.195.228.54:9200/estest/_search",
          data: JSON.stringify(query)
        }).done(function(data) {
          console.log(data);
        });
      }

      function search() {
        const Http = new XMLHttpRequest();
        const url =
          "https://cors-anywhere.herokuapp.com/http://35.195.228.54:9200/estest/_search?q=" +
          document.getElementById("search_input").value;

        Http.open("GET", url);
        Http.send();

        document.getElementById("results").innerHTML = "Loading...";

        Http.onreadystatechange = e => {
          var res = JSON.parse(Http.responseText);
          var text = "";
          res["hits"]["hits"].forEach(hit => {
            text += "<div class='hitbox'>";
            text += hit["_source"]["name"] + "<br>";
            text += hit["_source"]["Description"] + "<br>";
            text += "</div>";
          });
          // Show how it looks if we get multiple things.
          //      text += text;
          document.getElementById("results").innerHTML = text;
        };
      }

      function get_usr_topic_pref() {
        var usr_topic_pref = window.localStorage.getItem("topic_preferences");
        if (usr_topic_pref === null) {
          return [0.25, 0.25, 0.25, 0.25];
        } else {
          return JSON.parse(usr_topic_pref);
        }
      }

      // Get the input field
      var input = document.getElementById("search_input");

      // Execute a function when the user releases a key on the keyboard
      input.addEventListener("keyup", function(event) {
        // Number 13 is the "Enter" key on the keyboard
        if (event.keyCode === 13) {
          // Cancel the default action, if needed
          event.preventDefault();
          // Trigger the button element with a click
          document.getElementById("search_button").click();
        }
      });
    </script>
  </body>
</html>
