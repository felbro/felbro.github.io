<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>News suggestion</title>
    <meta name="description" content="News suggestion" />

    <style>
      .hitbox {
        border-style: solid;
      }
    </style>
  </head>

  <body>
    Search for news<br />
    <input type="text" name="news_search_bar" id="search_input" />
    <br />
    <br />
    <input type="button" value="Search" onclick="search()" id="search_button" />
    <br />
    <br />
    <input type="button" value="Suggest news" onclick="suggest_news()" />

    <div id="results"></div>

    <script>
      function suggest_news() {
        var my_item = window.localStorage.getItem("topic_preferences");
        if (my_item === null) {
          my_item = [0.25, 0.25, 0.25, 0.25];
        } else {
          my_item = JSON.parse(my_item);
        }
        // 1. Send it to elasticsearch.
        // 2. Get shit back (including the topic distribution).
        // 3. Show it.
        var returned_topic_distribution = [0.1, 0.01, 0.85, 0.04]; // Very temp
        const alpha = 0.9;
        for (let i = 0; i < my_item.length; i++) {
          my_item[i] =
            my_item[i] * alpha + returned_topic_distribution[i] * (1 - alpha);
        }
        window.localStorage.setItem(
          "topic_preferences",
          JSON.stringify(my_item)
        );

        // Just show something for now.
        var text = "";
        for (let i = 0; i < 4; i++) {
          text += "Suggested news piece " + i + "<br>";
        }
        document.getElementById("results").innerHTML = text;
      }

      function search() {
        const Http = new XMLHttpRequest();
        const url =
          "https://cors-anywhere.herokuapp.com/http://35.195.228.54:9200/estest/_search?q=" +
          document.getElementById("search_input").value;
        Http.open("GET", url);
        Http.send();

        document.getElementById("results").innerHTML = "Loading...";

        Http.onreadystatechange = e => {
          var res = JSON.parse(Http.responseText);
          var text = "";
          res["hits"]["hits"].forEach(hit => {
            text += "<div class='hitbox'>";
            text += hit["_source"]["name"] + "<br>";
            text += hit["_source"]["Description"] + "<br>";
            text += "</div>";
          });
          // Show how it looks if we get multiple things.
          text += text;
          document.getElementById("results").innerHTML = text;
        };
      }

      // Get the input field
      var input = document.getElementById("search_input");

      // Execute a function when the user releases a key on the keyboard
      input.addEventListener("keyup", function(event) {
        // Number 13 is the "Enter" key on the keyboard
        if (event.keyCode === 13) {
          // Cancel the default action, if needed
          event.preventDefault();
          // Trigger the button element with a click
          document.getElementById("search_button").click();
        }
      });
    </script>
  </body>
</html>
